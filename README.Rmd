---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE,
  warnings = FALSE
)
```

# midnight <img src="man/figures/logo.png" align="right" height="138"/>

<!-- badges: start -->

<!-- badges: end -->

The 'midnight' package implements a 'parsnip' engine for the 'midr' package, allowing users to seamlessly fit, tune, and evaluate MID (Maximum Interpretation Decomposition) models with 'tidymodels' workflows. Development and augmentation of the package are driven by research from the "Moonlight Seminar 2025", a collaborative study group of actuaries from the Institute of Actuaries of Japan focused on advancing the practical applications of interpretable models.

## Installation

You can install the development version of midnight from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("ryo-asashi/midnight")
```

## Fit MID Surrogate Models using 'parsnip'

This is a basic example which shows you how to solve a common problem:

```{r packages, message=FALSE}
library(tidymodels)
library(midr)
library(midnight)
library(gridExtra)
library(ISLR2)
```

```{r data}
# split dataset into training / validating subsets
set.seed(42)
usecol <- c("mnth", "hr", "workingday", "weathersit",
            "temp", "hum", "windspeed", "bikers")
all <- ISLR2::Bikeshare |>
  select(all_of(usecol)) |>
  mutate(workingday = as.factor(workingday))
holdout <- initial_split(all, prop = .5)
train <- training(holdout)
valid <- testing(holdout)
```

```{r 1d_fit, message = FALSE}
# create a first-order mid surrogate model
mid_spec_1 <- mid_reg()
mid_spec_1
# fit the model
mid_1 <- mid_spec_1 %>%
  fit(bikers ~ ., train)
mid_1
# evaluate the model
augment(mid_1, new_data = valid) %>%
  rmse(truth = bikers, estimate = .pred)
```

```{r ggmid_1d_fit}
grid.arrange(nrow = 2,
 ggmid(mid.importance(mid_1$fit), theme = "moon", max.nterms = 15),
 ggmid(mid_1$fit, "hr"),
 ggmid(mid_1$fit, "temp"),
 ggmid(mid_1$fit, "mnth")
)
```

```{r 2d_fit, message = FALSE}
# create a second-order mid surrogate model via "custom formula"
mid_spec_2 <- mid_reg(
  penalty = 0.000001, custom_formula = bikers ~ .^2
)
mid_spec_2
# fit the model
mid_2 <- mid_spec_2 %>%
  fit(bikers ~ ., train) # pass original data on to interpret()
mid_2
# evaluate the model
augment(mid_2, new_data = valid) %>%
  rmse(truth = bikers, estimate = .pred)
```

```{r ggmid_2d_fit}
grid.arrange(nrow = 2,
 ggmid(mid.importance(mid_2$fit), theme = "moon", max.nterms = 15),
 ggmid(mid_2$fit, "hr"),
 ggmid(mid_2$fit, "temp"),
 ggmid(mid_2$fit, "hr:workingday", type = "data", data = valid,
       main.effects = TRUE, theme = "moonlit")
)
```

```{r persp_mid}
par.midr()
persp(mid_2$fit, "temp:hr", theta = 50, phi = 20, shade = .5)
```

## Tune MID Surrogate Models using 'tune'

```{r tune}
# create a second-order mid surrogate model via "custom formula"
mid_spec <- mid_reg(
  params_main = tune(),
  params_inter = tune(),
  penalty = tune(),
  custom_formula = bikers ~ .^2
) %>%
  set_engine("midr", verbosity = 0)
mid_spec
# define a cross validation method
set.seed(42)
cv <- vfold_cv(train, v = 2)
# execute the hyperparameter tuning
tune_res <- mid_spec %>%
  tune_bayes(
    bikers ~ .,
    resamples = cv,
    iter = 50
  )
tune_best <- select_best(tune_res, metric = "rmse")
tune_best
```

```{r tuned_fit, message = FALSE}
# create a second-order mid surrogate model via "custom formula"
mid_spec <- mid_reg(
  params_main = tune_best$params_main,
  params_inter = tune_best$params_inter,
  penalty = tune_best$penalty,
  custom_formula = bikers ~ .^2
) %>%
  set_engine("midr", verbosity = 0, singular.ok = TRUE)
mid_spec
# fit the model
mid_tune <- mid_spec %>%
  fit(bikers ~ ., train) # pass original data on to interpret()
mid_tune
# evaluate the model
augment(mid_tune, new_data = valid) %>%
  rmse(truth = bikers, estimate = .pred)
```

```{r ggmid_tune_fit}
grid.arrange(nrow = 2,
 ggmid(mid.importance(mid_tune$fit), theme = "moon", max.nterms = 15),
 ggmid(mid_tune$fit, "hr"),
 ggmid(mid_tune$fit, "temp"),
 ggmid(mid_tune$fit, "hr:workingday", type = "data", data = valid,
       main.effects = TRUE, theme = "moonlit")
)
```

```{r persp_tuned_mid}
par.midr()
persp(mid_tune$fit, "temp:hr", theta = 50, phi = 20, shade = .5)
```
